<!DOCTYPE html>
<html>
<head>
    <title>Wallet Created</title>
    <style>
        .buttons-container {
            margin-top: 20px;
        }
        .wallet-button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>Wallet Created Successfully</h2>
    <p><strong>Chain:</strong> {{ chain }}</p>
    <p><strong>Address:</strong> {{ address }}</p>
    <h3>Balances:</h3>
    <p><strong>Ethereum (ETH):</strong> {{ balance_eth }} ETH</p>
    <p><strong>Binance Smart Chain (BNB):</strong> {{ balance_bnb }} BNB</p>
    <p><strong>Polygon (MATIC):</strong> {{ balance_matic }} MATIC</p>
    <h3>Token Balances:</h3>
    <ul>
        {% for token, balance in token_balances.items %}
            <li><strong>{{ token }}:</strong> {{ balance }}</li>
        {% endfor %}
    </ul>
    <div class="buttons-container">
        <button class="wallet-button" onclick="showModal('eth')">Send ETH</button>
        <button class="wallet-button" onclick="showModal('token')">Send Tokens</button>
    </div>

<!-- Modal window for sending ETH -->
    <div id="ethModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('eth')">&times;</span>
            <h2>Send ETH</h2>
            <p>Recipient Address:</p>
            <input type="text" id="ethRecipient" />
            <p>Amount in ETH:</p>
            <input type="number" id="ethAmount" oninput="updateUsdEquivalent(); calculateGas(); checkFunds();" />
            <p>Equivalent in USD: <span id="usdEquivalent">0.00</span></p>
            <p>Gas Fee: <span id="gasFee">0.00</span> ETH (<span id="gasFeeUsd">0.00</span> USD)</p>
            <p>Total with Gas: <span id="totalWithGas">0.00</span> ETH (<span id="totalWithGasUsd">0.00</span> USD)</p>
            <p class="error" id="fundsError" style="display:none;">Insufficient funds for the transaction.</p>
            <p>Enter password:</p>
            <input type="password" id="ethPassword" /><br>
            <button onclick="sendETH()">Send</button>
        </div>
    </div>

    <!-- Modal window for sending tokens -->
    <div id="tokenModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('token')">&times;</span>
            <h2>Send Tokens</h2>
            <p>Recipient Address:</p>
            <input type="text" id="tokenRecipient" />
            <p>Token:</p>
            <input type="text" id="tokenName" />
            <p>Amount:</p>
            <input type="number" id="tokenAmount" />
            <p>Enter password:</p>
            <input type="password" id="tokenPassword" /><br>
            <button onclick="sendToken()">Send</button>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const address = '{{ address }}';
        const encryptedKey = localStorage.getItem('encryptedKey');
        const chain = '{{ chain }}';

        const RPC_URLS = {
            eth: 'https://mainnet.infura.io/v3/a4c60cf1bd7e4c288d9221144f9efbe2',
            bnb: 'https://bsc-dataseed.binance.org/',
            matic: 'https://polygon-rpc.com/'
        };

        let ethToUsdRate = 0;
        let gasPrice = 0;
        let gasLimit = 21000; // Typically 21000 for ETH transfer
        let ethBalance = parseFloat('{{ balance_eth }}'); // Assuming the balance is passed from the server

        async function fetchEthToUsdRate() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
                const data = await response.json();
                ethToUsdRate = data.ethereum.usd;
                console.log('ETH to USD rate:', ethToUsdRate); // Debug log
            } catch (error) {
                console.error('Error fetching ETH to USD rate:', error);
            }
        }

        async function fetchGasPrice() {
            try {
                const provider = new ethers.providers.JsonRpcProvider(RPC_URLS['eth']);
                gasPrice = await provider.getGasPrice();
                gasPrice = parseFloat(ethers.utils.formatUnits(gasPrice, 'gwei'));
                calculateGas();
            } catch (error) {
                console.error('Error fetching gas price:', error);
            }
        }

        function calculateGas() {
            const ethAmount = document.getElementById('ethAmount').value;
            const gasFeeElement = document.getElementById('gasFee');
            const gasFeeUsdElement = document.getElementById('gasFeeUsd');
            const totalWithGasElement = document.getElementById('totalWithGas');
            const totalWithGasUsdElement = document.getElementById('totalWithGasUsd');
            const ethAmountNumber = parseFloat(ethAmount);

            if (!isNaN(ethAmountNumber) && ethAmountNumber > 0) {
                const gasFee = (gasPrice * gasLimit) / 1e9; // Convert gas fee to ETH
                const totalWithGas = ethAmountNumber + gasFee;
                const gasFeeUsd = gasFee * ethToUsdRate;
                const totalWithGasUsd = totalWithGas * ethToUsdRate;

                gasFeeElement.textContent = gasFee.toFixed(6);
                gasFeeUsdElement.textContent = gasFeeUsd.toFixed(2);
                totalWithGasElement.textContent = totalWithGas.toFixed(6);
                totalWithGasUsdElement.textContent = totalWithGasUsd.toFixed(2);

            } else {
                gasFeeElement.textContent = '0.00';
                gasFeeUsdElement.textContent = '0.00';
                totalWithGasElement.textContent = '0.00';
                totalWithGasUsdElement.textContent = '0.00';
            }
        }

        function checkFunds() {
            const ethAmount = document.getElementById('ethAmount').value;
            const ethAmountNumber = parseFloat(ethAmount);
            const totalWithGas = parseFloat(document.getElementById('totalWithGas').textContent);
            const fundsError = document.getElementById('fundsError');

            if (!isNaN(ethAmountNumber) && ethAmountNumber > 0) {
                if (ethBalance < totalWithGas) {
                    fundsError.style.display = 'block';
                } else {
                    fundsError.style.display = 'none';
                }
            } else {
                fundsError.style.display = 'none';
            }
        }

        function showModal(type) {
            const modal = document.getElementById(type === 'eth' ? 'ethModal' : 'tokenModal');
            modal.style.display = 'block';
            if (type === 'eth') {
                fetchEthToUsdRate();
                fetchGasPrice();
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(type === 'eth' ? 'ethModal' : 'tokenModal');
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = "none";
            }
        }

        function updateUsdEquivalent() {
            const ethAmount = document.getElementById('ethAmount').value;
            const usdEquivalent = document.getElementById('usdEquivalent');
            const ethAmountNumber = parseFloat(ethAmount);

            if (!isNaN(ethAmountNumber) && ethAmountNumber > 0) {
                const usdValue = (ethAmountNumber * ethToUsdRate).toFixed(2);
                usdEquivalent.textContent = usdValue;
            } else {
                usdEquivalent.textContent = '0.00';
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            fetchEthToUsdRate(); // Fetch the ETH to USD rate when the page loads
            fetchGasPrice(); // Fetch the Gas Price when the page loads
        });

        async function sendETH() {
            const recipient = document.getElementById('ethRecipient').value;
            const amount = document.getElementById('ethAmount').value;
            const password = document.getElementById('ethPassword').value;

            if (!recipient || !amount || !password) {
                alert('Please enter recipient address, amount, and password.');
                return;
            }

            try {
                // Fetch the latest gas price before sending the transaction
                await fetchGasPrice();

                const decryptedPrivateKey = CryptoJS.AES.decrypt(encryptedKey, password).toString(CryptoJS.enc.Utf8);
                const provider = new ethers.providers.JsonRpcProvider(RPC_URLS['eth']); // Using RPC URL for the Ethereum network
                const wallet = new ethers.Wallet(decryptedPrivateKey, provider);

                const gasPriceWei = ethers.utils.parseUnits(gasPrice.toString(), 'gwei');
                const tx = {
                    to: recipient,
                    value: ethers.utils.parseEther(amount),
                    gasPrice: gasPriceWei,
                    gasLimit: gasLimit
                };

                const balance = await wallet.getBalance();
                const totalCost = tx.value.add(gasPriceWei.mul(gasLimit));
                if (balance.lt(totalCost)) {
                    alert('Insufficient funds for the transaction.');
                    return;
                }

                const transactionResponse = await wallet.sendTransaction(tx);
                alert('Transaction sent: ' + transactionResponse.hash);
                closeModal('eth');
            } catch (error) {
                console.error("Error sending ETH:", error);
                alert('Error sending ETH: ' + error.message);
            }
        }

        async function sendToken() {
            const recipient = document.getElementById('tokenRecipient').value;
            const tokenName = document.getElementById('tokenName').value;
            const amount = document.getElementById('tokenAmount').value;
            const password = document.getElementById('tokenPassword').value;

            if (!recipient || !amount || !tokenName || !password) {
                alert('Please enter recipient address, token name, amount, and password.');
                return;
            }

            try {
                const token = TOKENS.find(t => t.name.toUpperCase() === tokenName.toUpperCase());
                if (!token) {
                    alert('Token not found.');
                    return;
                }

                const decryptedPrivateKey = CryptoJS.AES.decrypt(encryptedKey, password).toString(CryptoJS.enc.Utf8);
                const provider = new ethers.providers.JsonRpcProvider(RPC_URLS['eth']); // Using RPC URL for the Ethereum network
                const wallet = new ethers.Wallet(decryptedPrivateKey, provider);

                const tokenContract = new ethers.Contract(token.address, ERC20_ABI, wallet);
                const transactionResponse = await tokenContract.transfer(recipient, ethers.utils.parseUnits(amount, token.decimals));

                alert('Transaction sent: ' + transactionResponse.hash);
                closeModal('token');
            } catch (error) {
                console.error("Error sending token:", error);
                alert('Error sending token: ' + error.message);
            }
        }

        const TOKENS = [
            { name: 'USDT', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6 },
            { name: 'USDC', address: '0xA0b86991c6218b36c1d19D4a2e9EB0cE3606EB48', decimals: 6 },
        ];

        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function transfer(address to, uint256 value) returns (bool)",
            "function decimals() view returns (uint8)"
        ];
    </script>
</body>
</html>
